<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>健身節奏計時器</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        }
        
        .container {
            background: rgba(15, 23, 42, 0.9);
            padding: 30px 25px;
            border-radius: 25px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7),
                        0 0 0 1px rgba(255, 255, 255, 0.1);
            text-align: center;
            width: 100%;
            max-width: 450px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .counter {
            font-size: clamp(48px, 15vw, 80px);
            font-weight: 800;
            color: #4cc9f0;
            margin: 20px 0 25px;
            text-shadow: 0 0 20px rgba(76, 201, 240, 0.5),
                         0 0 40px rgba(76, 201, 240, 0.3);
            letter-spacing: -2px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Arial Black', 'Segoe UI', sans-serif;
        }
        
        .phase {
            font-size: clamp(16px, 4vw, 22px);
            color: #cbd5e1;
            margin: 20px 0 25px;
            min-height: 30px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .progress-container {
            margin: 30px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 18px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4361ee 0%, #3a0ca3 100%);
            width: 0%;
            transition: width 0.1s linear;
            position: relative;
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.1);
        }
        
        .input-group {
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        
        .input-group label {
            font-size: clamp(14px, 3.5vw, 17px);
            color: #e2e8f0;
            font-weight: 500;
            text-align: left;
            flex: 1;
        }
        
        .input-group input {
            font-size: clamp(14px, 3.5vw, 17px);
            padding: 10px 15px;
            border: 2px solid #4361ee;
            border-radius: 10px;
            width: 80px;
            text-align: center;
            background: rgba(15, 23, 42, 0.8);
            color: #ffffff;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #4cc9f0;
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.2);
        }
        
        .input-group input:disabled {
            background: rgba(51, 65, 85, 0.6);
            color: #cbd5e1;
            border-color: #475569;
            opacity: 0.7;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        button {
            font-size: clamp(14px, 3.5vw, 18px);
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            letter-spacing: 0.5px;
            min-width: 120px;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .play-btn {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.3);
        }
        
        .play-btn:active {
            transform: scale(0.95);
        }
        
        .stop-btn {
            background: linear-gradient(135deg, #f72545 0%, #b5179e 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(247, 37, 69, 0.3);
        }
        
        .stop-btn:active {
            transform: scale(0.95);
        }
        
        .audio-status {
            font-size: 11px;
            color: #888;
            margin-top: 15px;
            min-height: 16px;
            padding: 5px;
        }
        
        .status-ok { color: #4ade80 !important; }
        .status-warn { color: #fbbf24 !important; }
        .status-error { color: #f87171 !important; }
        
        @media (max-width: 400px) {
            .container {
                padding: 25px 20px;
            }
            
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-group label {
                text-align: center;
            }
            
            .input-group input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="counter" id="counter">準備開始</div>
        <div class="phase" id="phase"></div>
        
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
        </div>
        
        <div class="input-group">
            <label for="repsInput">每組次數：</label>
            <input type="number" id="repsInput" value="12" min="1" max="50" inputmode="numeric">
        </div>
        <div class="input-group">
            <label for="setsInput">組數：</label>
            <input type="number" id="setsInput" value="3" min="1" max="10" inputmode="numeric">
        </div>
        <div class="input-group">
            <label for="restInput">組間休息(秒)：</label>
            <input type="number" id="restInput" value="60" min="10" max="300" step="5" inputmode="numeric">
        </div>
        
        <div class="button-group">
            <button class="play-btn" id="playBtn">開始訓練</button>
            <button class="stop-btn" id="stopBtn" style="display:none;">停止訓練</button>
        </div>
        
        <div class="audio-status" id="audioStatus">音頻未初始化</div>
    </div>

<script>
    // 核心狀態變數
    let intervalId = null;
    let startTime = null;
    let pausedTime = 0;
    let currentRep = 0;
    let currentSet = 0;
    let totalReps = 12;
    let totalSets = 3;
    let restTime = 60;
    let isPreparation = true;
    let isResting = false;
    let hasWarned = false;
    let lastSpokenNumber = -1;
    const preparationTime = 10.0;
    const repDuration = 4.5;
    
    // 音頻系統變數
    let audioContext = null;
    let audioEnabled = false;
    let voiceEnabled = false;
    let lastBeepTime = 0;
    let pendingSpeech = null;
    
    // 偵測設備類型
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    
    // 更新狀態顯示
    function updateAudioStatus(message, type = 'info') {
        const el = document.getElementById('audioStatus');
        if (!el) return;
        
        el.textContent = message;
        el.className = 'audio-status';
        
        if (type === 'ok') el.classList.add('status-ok');
        else if (type === 'warn') el.classList.add('status-warn');
        else if (type === 'error') el.classList.add('status-error');
    }
    
    // 初始化音頻系統 (簡化版)
    async function initAudio() {
        if (audioContext) return true;
        
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
            
            audioEnabled = audioContext.state === 'running';
            updateAudioStatus(audioEnabled ? '音頻已就緒' : '音頻暫停', audioEnabled ? 'ok' : 'warn');
            return audioEnabled;
        } catch (e) {
            console.error('音頻初始化失敗:', e);
            updateAudioStatus('音頻不可用', 'error');
            return false;
        }
    }
    
    // 確保音頻運行
    async function ensureAudioRunning() {
        if (!audioContext) {
            return await initAudio();
        }
        
        if (audioContext.state === 'suspended') {
            try {
                await audioContext.resume();
                audioEnabled = true;
                updateAudioStatus('音頻已恢復', 'ok');
            } catch (e) {
                console.error('恢復音頻失敗:', e);
                audioEnabled = false;
            }
        }
        
        return audioEnabled;
    }
    
    // 播放提示音 (節流版)
    async function playBeep() {
        const now = Date.now();
        if (now - lastBeepTime < 100) return; // 防止過於頻繁
        lastBeepTime = now;
        
        if (!await ensureAudioRunning()) return;
        
        try {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            
            osc.connect(gain);
            gain.connect(audioContext.destination);
            
            osc.frequency.value = 800;
            osc.type = 'sine';
            
            const t = audioContext.currentTime;
            gain.gain.setValueAtTime(0.3, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
            
            osc.start(t);
            osc.stop(t + 0.15);
            
            // 自動清理
            setTimeout(() => {
                try {
                    osc.disconnect();
                    gain.disconnect();
                } catch (e) {}
            }, 200);
        } catch (e) {
            console.error('播放提示音失敗:', e);
        }
    }
    
    // 語音系統 (改良版)
    function initVoice() {
        if (!('speechSynthesis' in window)) {
            voiceEnabled = false;
            return false;
        }
        
        // 清除舊的語音
        speechSynthesis.cancel();
        
        // 測試語音 (靜音)
        const test = new SpeechSynthesisUtterance('');
        test.volume = 0;
        speechSynthesis.speak(test);
        
        setTimeout(() => speechSynthesis.cancel(), 50);
        
        voiceEnabled = true;
        return true;
    }
    
    // 語音播報 (防抖版)
    function speak(text) {
        if (!voiceEnabled) return;
        
        // 清除待處理的語音
        if (pendingSpeech) {
            clearTimeout(pendingSpeech);
            pendingSpeech = null;
        }
        
        // 立即取消當前語音
        speechSynthesis.cancel();
        
        // 延遲執行新語音 (給取消操作時間)
        pendingSpeech = setTimeout(() => {
            try {
                const utterance = new SpeechSynthesisUtterance(text.toString());
                utterance.lang = 'zh-TW';
                utterance.rate = isIOS ? 0.85 : 0.9;
                utterance.pitch = 1.0;
                utterance.volume = isIOS ? 0.9 : 1.0;
                
                speechSynthesis.speak(utterance);
            } catch (e) {
                console.error('語音播報失敗:', e);
            }
            pendingSpeech = null;
        }, 50);
    }
    
    // 計算當前時間 (精確版)
    function getCurrentTime() {
        if (!startTime) return 0;
        return (Date.now() - startTime) / 1000 + pausedTime;
    }
    
    // 更新顯示
    function updateDisplay() {
        const counter = document.getElementById('counter');
        const phase = document.getElementById('phase');
        const progress = document.getElementById('progress');
        
        const currentTime = getCurrentTime();
        
        if (isPreparation) {
            const remaining = Math.ceil(preparationTime - currentTime);
            counter.textContent = remaining > 0 ? remaining : '開始!';
            phase.textContent = '準備中...';
            const percent = Math.min(100, (currentTime / preparationTime) * 100);
            progress.style.width = percent + '%';
            return;
        }
        
        if (isResting) {
            const restRemaining = Math.ceil(restTime - currentTime);
            counter.textContent = '休息';
            phase.textContent = `${restRemaining} 秒後開始第 ${currentSet + 1} 組`;
            const percent = Math.min(100, (currentTime / restTime) * 100);
            progress.style.width = percent + '%';
            return;
        }
        
        const phaseTime = currentTime % repDuration;
        counter.textContent = `第 ${currentRep + 1} 下`;
        
        if (phaseTime < 1.5) {
            phase.textContent = '出力 (向心)';
        } else if (phaseTime < 2.0) {
            phase.textContent = '頂端停頓';
        } else if (phaseTime < 4.0) {
            phase.textContent = '放下 (離心)';
        } else {
            phase.textContent = '底部停頓';
        }
        
        const percent = (phaseTime / repDuration) * 100;
        progress.style.width = percent + '%';
    }
    
    // 主計時邏輯
    function timerTick() {
        const currentTime = getCurrentTime();
        
        if (isPreparation) {
            if (currentTime >= preparationTime) {
                isPreparation = false;
                startTime = Date.now();
                pausedTime = 0;
                speak(1);
                lastSpokenNumber = 1;
            }
        } else if (isResting) {
            if (currentTime >= restTime - 10 && !hasWarned) {
                speak('準備開始');
                hasWarned = true;
            }
            
            if (currentTime >= restTime) {
                isResting = false;
                hasWarned = false;
                startTime = Date.now();
                pausedTime = 0;
                currentRep = 0;
                speak(1);
                lastSpokenNumber = 1;
            }
        } else {
            const completedReps = Math.floor(currentTime / repDuration);
            const phaseTime = currentTime % repDuration;
            
            if (completedReps !== currentRep) {
                currentRep = completedReps;
                
                if (currentRep >= totalReps) {
                    currentSet++;
                    if (currentSet < totalSets) {
                        isResting = true;
                        startTime = Date.now();
                        pausedTime = 0;
                        hasWarned = false;
                        lastSpokenNumber = -1;
                    } else {
                        stopWorkout();
                        document.getElementById('counter').textContent = '完成!';
                        document.getElementById('phase').textContent = '所有組數訓練結束';
                        speak('訓練完成');
                        return;
                    }
                } else {
                    lastSpokenNumber = -1;
                }
            }
            
            // 播報下一個數字
            if (phaseTime < 0.2 && lastSpokenNumber !== currentRep + 1 && currentRep < totalReps) {
                speak(currentRep + 1);
                lastSpokenNumber = currentRep + 1;
            }
            
            // 提示音
            if (phaseTime >= 1.95 && phaseTime <= 2.05) {
                playBeep();
            }
        }
        
        updateDisplay();
    }
    
    // 開始訓練
    async function startWorkout() {
        if (intervalId) return;
        
        // 獲取並驗證輸入
        totalReps = parseInt(document.getElementById('repsInput').value) || 12;
        totalSets = parseInt(document.getElementById('setsInput').value) || 3;
        restTime = parseInt(document.getElementById('restInput').value) || 60;
        
        if (totalReps < 1 || totalReps > 50) {
            alert('請輸入1-50之間的次數');
            return;
        }
        if (totalSets < 1 || totalSets > 10) {
            alert('請輸入1-10之間的組數');
            return;
        }
        if (restTime < 10 || restTime > 300) {
            alert('請輸入10-300秒之間的休息時間');
            return;
        }
        
        // 初始化音頻和語音
        await initAudio();
        initVoice();
        
        // 測試音頻
        playBeep();
        
        // UI 更新
        document.getElementById('playBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'block';
        document.getElementById('repsInput').disabled = true;
        document.getElementById('setsInput').disabled = true;
        document.getElementById('restInput').disabled = true;
        
        // 重置狀態
        currentRep = 0;
        currentSet = 0;
        isPreparation = true;
        isResting = false;
        hasWarned = false;
        lastSpokenNumber = -1;
        startTime = Date.now();
        pausedTime = 0;
        
        // 開始計時
        intervalId = setInterval(timerTick, 100);
    }
    
    // 停止訓練
    function stopWorkout() {
        if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
        }
        
        if (pendingSpeech) {
            clearTimeout(pendingSpeech);
            pendingSpeech = null;
        }
        
        speechSynthesis.cancel();
        
        document.getElementById('playBtn').style.display = 'block';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('repsInput').disabled = false;
        document.getElementById('setsInput').disabled = false;
        document.getElementById('restInput').disabled = false;
        document.getElementById('progress').style.width = '0%';
        document.getElementById('counter').textContent = '準備開始';
        document.getElementById('phase').textContent = '';
    }
    
    // 頁面可見性處理
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && intervalId && audioContext) {
            ensureAudioRunning();
        }
    });
    
    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('playBtn').addEventListener('click', startWorkout);
        document.getElementById('stopBtn').addEventListener('click', stopWorkout);
        
        updateAudioStatus('點擊開始以啟用音頻', 'info');
    });
</script>
</body>
</html>

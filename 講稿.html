<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>講稿閱讀器 - 穩定縮放版</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
      overflow: hidden;
      /* 使用 dvh 確保在手機網址列出現時高度依然正確 */
      width: 100vw;
      height: 100dvh;
      background: #1a1a1a;
      color: #fff;
      touch-action: manipulation; /* 允許縮放但優化點擊 */
      -webkit-text-size-adjust: none;
    }
    
    #container {
      width: 100%;
      height: 100%;
      display: flex;
      transition: transform 0.3s ease;
    }
    
    .page {
      min-width: 100vw;
      height: 100dvh;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 80px 30px 60px;
      -webkit-overflow-scrolling: touch;
    }
    
    .page-content {
      line-height: 1.8;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .edit-area {
      width: 100%;
      min-height: 70dvh;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 15px;
      border-radius: 8px;
      font-size: inherit;
      font-family: inherit;
      line-height: 1.8;
      resize: none;
      outline: none;
    }

    /* 固定定位的 UI 元件 */
    .floating-ui {
      position: fixed;
      z-index: 1000;
      /* 確保縮放時變形起點在正確位置 */
      transform-origin: top right; 
    }

    .controls {
      top: 15px;
      right: 15px;
      display: flex;
      gap: 10px;
    }
    
    .page-number {
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.2);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      transform-origin: center bottom;
      white-space: nowrap;
    }
    
    button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .edit-btn {
      background: rgba(52, 152, 219, 0.5);
    }
  </style>
</head>
<body>
  <div class="controls floating-ui" id="controls">
    <button id="decreaseFont">小</button>
    <button id="increaseFont">大</button>
    <button class="edit-btn" id="editBtn">✏️</button>
  </div>
  
  <div id="container"></div>
  <div class="page-number floating-ui" id="pageNumber">1 / 1</div>

  <script>
    let fontSize = 18;
    let currentPage = 0;
    let pages = [];
    let startX = 0;
    let startY = 0;
    let isDragging = false;
    let isEditMode = false;
    
    // --- 縮放修正邏輯 ---
    function adjustFloatingUI() {
      if (!window.visualViewport) return;
      
      const vv = window.visualViewport;
      const controls = document.getElementById('controls');
      const pageNum = document.getElementById('pageNumber');
      
      // 計算縮放比例
      const scale = 1 / vv.scale;
      
      // 修正控制按鈕位置與大小
      controls.style.transform = `scale(${scale})`;
      controls.style.top = `${vv.offsetTop + (15 * scale)}px`;
      controls.style.left = `${vv.offsetLeft + vv.width - (controls.offsetWidth * scale) - (15 * scale)}px`;
      
      // 修正頁碼位置與大小
      pageNum.style.transform = `translateX(-50%) scale(${scale})`;
      pageNum.style.left = `${vv.offsetLeft + (vv.width / 2)}px`;
      pageNum.style.top = `${vv.offsetTop + vv.height - (pageNum.offsetHeight * scale) - (20 * scale)}px`;
    }

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', adjustFloatingUI);
      window.visualViewport.addEventListener('scroll', adjustFloatingUI);
    }
    // ------------------

    const defaultPages = [
      '第一頁講稿\n\n歡迎使用手機講稿閱讀器！\n\n現在即使您用雙指放大畫面，按鈕也會保持在正確的位置了。\n\n• 從右往左滑動翻頁\n• 點擊"編輯"修改內容',
      ''
    ];

    function loadPages() {
      const saved = localStorage.getItem('speechPages');
      if (saved) {
        const parsed = JSON.parse(saved);
        if (parsed.length === 0 || parsed[parsed.length - 1].trim() !== '') {
          parsed.push('');
        }
        return parsed;
      }
      return [...defaultPages];
    }
    
    function savePages() {
      const filtered = pages.filter((p, i) => p.trim() !== '' || i === pages.length - 1);
      if (filtered.length === 0 || filtered[filtered.length-1] !== '') filtered.push('');
      pages = filtered;
      localStorage.setItem('speechPages', JSON.stringify(pages));
    }
    
    function renderPages() {
      const container = document.getElementById('container');
      container.innerHTML = '';
      
      pages.forEach((pageContent, index) => {
        const pageDiv = document.createElement('div');
        pageDiv.className = 'page';
        
        if (isEditMode) {
          const textarea = document.createElement('textarea');
          textarea.className = 'edit-area';
          textarea.style.fontSize = fontSize + 'px';
          textarea.value = pageContent;
          textarea.dataset.index = index;
          
          textarea.addEventListener('input', (e) => {
            pages[index] = e.target.value;
            savePages();
            if (index === pages.length - 1 && e.target.value.trim() !== '') {
              renderPages();
              setTimeout(() => {
                const news = document.querySelector(`textarea[data-index="${index}"]`);
                if (news) { news.focus(); news.selectionStart = news.value.length; }
              }, 0);
            }
          });
          pageDiv.appendChild(textarea);
        } else {
          const contentDiv = document.createElement('div');
          contentDiv.className = 'page-content';
          contentDiv.style.fontSize = fontSize + 'px';
          contentDiv.textContent = pageContent || (index === pages.length - 1 ? '(空白頁)' : '');
          pageDiv.appendChild(contentDiv);
        }
        container.appendChild(pageDiv);
      });
      
      updatePageDisplay();
    }
    
    function updatePageDisplay() {
      const container = document.getElementById('container');
      container.style.transform = `translateX(-${currentPage * 100}vw)`;
      document.getElementById('pageNumber').textContent = `${currentPage + 1} / ${pages.length}`;
      localStorage.setItem('currentPage', currentPage);
      adjustFloatingUI(); // 切換頁面時重新校正 UI
    }
    
    function changePage(delta) {
      const newPage = currentPage + delta;
      if (newPage >= 0 && newPage < pages.length) {
        currentPage = newPage;
        updatePageDisplay();
      }
    }

    document.getElementById('increaseFont').addEventListener('click', () => {
      if (fontSize < 50) { fontSize += 2; renderPages(); }
    });
    
    document.getElementById('decreaseFont').addEventListener('click', () => {
      if (fontSize > 12) { fontSize -= 2; renderPages(); }
    });
    
    document.getElementById('editBtn').addEventListener('click', () => {
      isEditMode = !isEditMode;
      document.getElementById('editBtn').textContent = isEditMode ? '✓' : '✏️';
      renderPages();
    });

    // 觸控翻頁邏輯
    document.body.addEventListener('touchstart', (e) => {
      if (isEditMode || (window.visualViewport && window.visualViewport.scale > 1)) return;
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      isDragging = true;
    });
    
    document.body.addEventListener('touchend', (e) => {
      if (!isDragging) return;
      const deltaX = e.changedTouches[0].clientX - startX;
      const deltaY = e.changedTouches[0].clientY - startY;
      
      if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 80) {
        changePage(deltaX > 0 ? -1 : 1);
      }
      isDragging = false;
    });

    // 初始化
    fontSize = parseInt(localStorage.getItem('fontSize')) || 18;
    currentPage = parseInt(localStorage.getItem('currentPage')) || 0;
    pages = loadPages();
    renderPages();
    window.onload = adjustFloatingUI;
  </script>
</body>
</html>

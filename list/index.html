<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>清單總管</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f3460;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    h1 { margin-bottom: 20px; }
    ul { list-style: none; padding: 0; }
    li {
      background: #16213e;
      margin: 10px auto;
      padding: 10px 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 400px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    a { color: #4a9eff; text-decoration: none; font-weight: bold; }
    button {
      background: #ff4757;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #e84118; }
    #addBtn {
      margin-top: 20px;
      background: linear-gradient(45deg, #4a9eff, #ff6b9d);
    }
  </style>
</head>
<body>
  <h1>📂 我的清單</h1>
  <ul id="listContainer"></ul>
  <button id="addBtn">➕ 新增清單</button>

   <script>
    const container = document.getElementById("listContainer");
    
    // 關鍵修正 1: 確保 ID 帶有 'list_' 前綴且足夠唯一
    function generateId() {
      // 使用更長的 ID 確保唯一性
      return 'list_' + Date.now() + '' + Math.floor(Math.random() * 99999);
    }
    
    // 關鍵修正 2: 穩健地讀取清單列表
    function getAllLists() {
      const lists = [];
      const idSet = new Set(); // 用於存儲不重複的基礎 ID

      // 步驟 A: 遍歷所有 localStorage keys，尋找所有清單的基礎 ID
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);

        if (key.startsWith("list_")) {
            let baseId = null;
            
            // 從子清單的 Key 中解析出基礎 ID (list_XXX)
            if (key.endsWith("_title")) {
                baseId = key.replace("_title", "");
            } else if (key.endsWith("_items")) {
                baseId = key.replace("_items", "");
            }
            
            // 只有成功解析出基礎 ID 才加入 Set
            if (baseId) {
                idSet.add(baseId);
            }
        }
      }

      // 步驟 B: 根據基礎 ID 讀取標題，並確認清單內容是否存在
      idSet.forEach(id => {
          const titleKey = id + "_title";
          const itemsKey = id + "_items";

          // 讀取標題 (如果不存在，則為 null)
          const title = localStorage.getItem(titleKey);
          
          // 讀取清單項目 (用於驗證清單是否為空/有效)
          const items = localStorage.getItem(itemsKey);

          // 只有當至少有標題 Key 或內容 Key 存在時，才視為有效清單
          if (title !== null || items !== null) {
              // 如果標題為 null 或空字串，則使用預設值
              const listTitle = (title && title.trim() !== "") ? title : "未命名清單";
              
              // 加入列表
              lists.push({ id: id, title: listTitle });
          }
      });

      return lists;
    }
    
    function render() {
      const allLists = getAllLists();
      container.innerHTML = "";
      if (allLists.length === 0) {
          container.innerHTML = '<li style="justify-content: center; background: #16213e;">目前沒有任何清單。</li>';
          return;
      }
      allLists.forEach(list => {
        const li = document.createElement("li");
        li.innerHTML = 
          `<a href="list.html?id=${encodeURIComponent(list.id)}">${list.title}</a>
          <button onclick="deleteList('${list.id}')">刪除</button>`;
        container.appendChild(li);
      });
    }

    function addList() {
      const id = generateId();
      const defaultTitle = "新清單"; 
      
      // 關鍵修正 3: 新增清單時，同步建立子清單預期的兩個 Key
      
      // 1. 儲存預設標題
      localStorage.setItem(id + "_title", defaultTitle); 
      
      // 2. 儲存預設項目 (子清單預期 [""]，避免錯誤)
      localStorage.setItem(id + "_items", JSON.stringify([''])); 
      
      // 立即導航至新清單頁面
      window.location.href = `list.html?id=${encodeURIComponent(id)}`;
      
      // 注意：這裡不呼叫 render()，因為頁面會跳轉
    }
    
    // 關鍵修正 4: 刪除清單時，必須同步刪除子清單儲存的所有相關 Key
    function deleteList(id) {
      if (!confirm("確定要刪除這個清單嗎？這將同時移除清單標題和內容。")) return;
      
      // 刪除標題 Key
      localStorage.removeItem(id + "_title");
      
      // 刪除項目 Key
      localStorage.removeItem(id + "_items");
      
      render(); // 重新渲染母清單
    }
    
    document.getElementById("addBtn").addEventListener("click", addList);
    render();
</script>
</body>
</html>

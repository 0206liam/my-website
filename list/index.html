<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>清單總管</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f3460;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    h1 { margin-bottom: 20px; }
    ul { list-style: none; padding: 0; }
    li {
      background: #16213e;
      margin: 10px auto;
      padding: 10px 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 400px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    a { color: #4a9eff; text-decoration: none; font-weight: bold; }
    button {
      background: #ff4757;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #e84118; }
    #addBtn {
      margin-top: 20px;
      background: linear-gradient(45deg, #4a9eff, #ff6b9d);
    }
    .error-message {
      background: #ff4757;
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin: 10px auto;
      max-width: 400px;
    }
  </style>
</head>
<body>
  <h1>📂 我的清單</h1>
  <div id="errorContainer"></div>
  <ul id="listContainer"></ul>
  <button id="addBtn">➕ 新增清單</button>

  <script>
    const container = document.getElementById("listContainer");
    const errorContainer = document.getElementById("errorContainer");
    
    // 改善的 ID 生成函數
    function generateId() {
      const timestamp = Date.now();
      const random = Math.random().toString(36).substr(2, 9);
      return `list_${timestamp}_${random}`;
    }
    
    // HTML 轉義函數，防止 XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // 錯誤處理函數
    function showError(message) {
      errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
      setTimeout(() => {
        errorContainer.innerHTML = '';
      }, 5000);
    }
    
    // localStorage 安全操作包裝
    function safeGetItem(key) {
      try {
        return localStorage.getItem(key);
      } catch (e) {
        showError('讀取資料時發生錯誤');
        return null;
      }
    }
    
    function safeSetItem(key, value) {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch (e) {
        showError('儲存資料時發生錯誤，可能是儲存空間不足');
        return false;
      }
    }
    
    function safeRemoveItem(key) {
      try {
        localStorage.removeItem(key);
        return true;
      } catch (e) {
        showError('刪除資料時發生錯誤');
        return false;
      }
    }
    
    // 改善的清單讀取函數
    function getAllLists() {
      const lists = [];
      const processedIds = new Set();

      try {
        // 遍歷 localStorage keys
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          
          if (!key || !key.startsWith("list_")) continue;
          
          let baseId = null;
          
          // 解析基礎 ID
          if (key.endsWith("_title")) {
            baseId = key.slice(0, -6); // 移除 "_title"
          } else if (key.endsWith("_items")) {
            baseId = key.slice(0, -6); // 移除 "_items"
          }
          
          // 避免重複處理同一個清單
          if (baseId && !processedIds.has(baseId)) {
            processedIds.add(baseId);
            
            const titleKey = baseId + "_title";
            const itemsKey = baseId + "_items";
            
            const title = safeGetItem(titleKey);
            const items = safeGetItem(itemsKey);
            
            // 確保至少有一個 key 存在
            if (title !== null || items !== null) {
              const listTitle = (title && title.trim() !== "") ? title : "未命名清單";
              lists.push({ id: baseId, title: listTitle });
            }
          }
        }
      } catch (e) {
        showError('載入清單時發生錯誤');
      }
      
      // 按 ID 排序，確保顯示順序一致
      return lists.sort((a, b) => a.id.localeCompare(b.id));
    }
    
    // 改善的渲染函數
    function render() {
      const allLists = getAllLists();
      container.innerHTML = "";
      
      if (allLists.length === 0) {
        container.innerHTML = '<li style="justify-content: center; background: #16213e;">目前沒有任何清單。</li>';
        return;
      }
      
      allLists.forEach(list => {
        const li = document.createElement("li");
        
        // 創建連結元素
        const link = document.createElement("a");
        link.href = `list.html?id=${encodeURIComponent(list.id)}`;
        link.textContent = list.title; // 使用 textContent 防止 XSS
        
        // 創建刪除按鈕
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "刪除";
        deleteBtn.addEventListener("click", () => deleteList(list.id));
        
        li.appendChild(link);
        li.appendChild(deleteBtn);
        container.appendChild(li);
      });
    }

    // 改善的新增清單函數
    function addList() {
      const id = generateId();
      const defaultTitle = "新清單";
      
      // 檢查 ID 是否已存在（雖然機率很低）
      if (safeGetItem(id + "_title") !== null || safeGetItem(id + "_items") !== null) {
        showError('產生唯一 ID 失敗，請重試');
        return;
      }
      
      // 儲存資料
      const titleSaved = safeSetItem(id + "_title", defaultTitle);
      const itemsSaved = safeSetItem(id + "_items", JSON.stringify(['']));
      
      if (titleSaved && itemsSaved) {
        // 確保資料已儲存後再導航
        window.location.href = `list.html?id=${encodeURIComponent(id)}`;
      }
    }
    
    // 改善的刪除清單函數
    function deleteList(id) {
      if (!confirm("確定要刪除這個清單嗎？這將同時移除清單標題和內容。")) {
        return;
      }
      
      // 刪除相關的所有 keys
      const titleRemoved = safeRemoveItem(id + "_title");
      const itemsRemoved = safeRemoveItem(id + "_items");
      
      if (titleRemoved && itemsRemoved) {
        render(); // 重新渲染
      }
    }
    
    // 事件監聽器
    document.getElementById("addBtn").addEventListener("click", addList);
    
    // 頁面載入時檢查 localStorage 是否可用
    function checkLocalStorageAvailability() {
      try {
        const testKey = '__test_key__';
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        return true;
      } catch (e) {
        showError('瀏覽器不支援本地儲存功能，應用可能無法正常運作');
        return false;
      }
    }
    
    // 初始化
    if (checkLocalStorageAvailability()) {
      render();
    }
  </script>
</body>
</html>

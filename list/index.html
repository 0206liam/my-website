<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸…å–®ç¸½ç®¡</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f3460;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    h1 { margin-bottom: 20px; }
    ul { list-style: none; padding: 0; }
    li {
      background: #16213e;
      margin: 10px auto;
      padding: 10px 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 400px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    a { color: #4a9eff; text-decoration: none; font-weight: bold; }
    button {
      background: #ff4757;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #e84118; }
    #addBtn {
      margin-top: 20px;
      background: linear-gradient(45deg, #4a9eff, #ff6b9d);
    }
    .error-message {
      background: #ff4757;
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin: 10px auto;
      max-width: 400px;
    }
  </style>
</head>
<body>
  <h1>ğŸ“‚ æˆ‘çš„æ¸…å–®</h1>
  <div id="errorContainer"></div>
  <ul id="listContainer"></ul>
  <button id="addBtn">â• æ–°å¢æ¸…å–®</button>

  <script>
    const container = document.getElementById("listContainer");
    const errorContainer = document.getElementById("errorContainer");
    
    // æ”¹å–„çš„ ID ç”Ÿæˆå‡½æ•¸
    function generateId() {
      const timestamp = Date.now();
      const random = Math.random().toString(36).substr(2, 9);
      return `list_${timestamp}_${random}`;
    }
    
    // HTML è½‰ç¾©å‡½æ•¸ï¼Œé˜²æ­¢ XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // éŒ¯èª¤è™•ç†å‡½æ•¸
    function showError(message) {
      errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
      setTimeout(() => {
        errorContainer.innerHTML = '';
      }, 5000);
    }
    
    // localStorage å®‰å…¨æ“ä½œåŒ…è£
    function safeGetItem(key) {
      try {
        return localStorage.getItem(key);
      } catch (e) {
        showError('è®€å–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤');
        return null;
      }
    }
    
    function safeSetItem(key, value) {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch (e) {
        showError('å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œå¯èƒ½æ˜¯å„²å­˜ç©ºé–“ä¸è¶³');
        return false;
      }
    }
    
    function safeRemoveItem(key) {
      try {
        localStorage.removeItem(key);
        return true;
      } catch (e) {
        showError('åˆªé™¤è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤');
        return false;
      }
    }
    
    // æ”¹å–„çš„æ¸…å–®è®€å–å‡½æ•¸
    function getAllLists() {
      const lists = [];
      const processedIds = new Set();

      try {
        // éæ­· localStorage keysï¼Œæ‰¾å‡ºæ‰€æœ‰æ¸…å–®çš„åŸºç¤ ID
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          
          if (!key || !key.startsWith("list_")) continue;
          
          let baseId = null;
          
          // è§£æåŸºç¤ ID - ä¿®æ­£é‚è¼¯ï¼Œç¢ºä¿æ­£ç¢ºè§£æ
          if (key.endsWith("_title")) {
            baseId = key.slice(0, -6); // ç§»é™¤ "_title"
          } else if (key.endsWith("_items")) {
            baseId = key.slice(0, -6); // ç§»é™¤ "_items"
          }
          
          // é¿å…é‡è¤‡è™•ç†åŒä¸€å€‹æ¸…å–®
          if (baseId && !processedIds.has(baseId)) {
            processedIds.add(baseId);
          }
        }
        
        // ç‚ºæ¯å€‹æ‰¾åˆ°çš„åŸºç¤ ID è®€å–è³‡æ–™
        processedIds.forEach(baseId => {
          const titleKey = baseId + "_title";
          const itemsKey = baseId + "_items";
          
          const title = safeGetItem(titleKey);
          const items = safeGetItem(itemsKey);
          
          // ç¢ºä¿è‡³å°‘æœ‰ä¸€å€‹ key å­˜åœ¨ä¸”æœ‰æ•ˆ
          if (title !== null || items !== null) {
            // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„é …ç›®è³‡æ–™
            let hasValidData = false;
            
            if (items !== null) {
              try {
                const itemsArray = JSON.parse(items);
                hasValidData = Array.isArray(itemsArray);
              } catch (e) {
                hasValidData = false;
              }
            }
            
            // åªæœ‰ç•¶æ¨™é¡Œå­˜åœ¨æˆ–é …ç›®è³‡æ–™æœ‰æ•ˆæ™‚æ‰é¡¯ç¤º
            if (title !== null || hasValidData) {
              const listTitle = (title && title.trim() !== "") ? title.trim() : "æœªå‘½åæ¸…å–®";
              lists.push({ id: baseId, title: listTitle });
            }
          }
        });
      } catch (e) {
        showError('è¼‰å…¥æ¸…å–®æ™‚ç™¼ç”ŸéŒ¯èª¤');
        console.error('getAllLists error:', e);
      }
      
      // æŒ‰å‰µå»ºæ™‚é–“æ’åºï¼ˆå¾ ID ä¸­æå–æ™‚é–“æˆ³ï¼‰
      return lists.sort((a, b) => {
        const timeA = extractTimestamp(a.id);
        const timeB = extractTimestamp(b.id);
        return timeB - timeA; // æ–°çš„åœ¨å‰
      });
    }
    
    // å¾ ID ä¸­æå–æ™‚é–“æˆ³çš„è¼”åŠ©å‡½æ•¸
    function extractTimestamp(id) {
      const parts = id.split('_');
      if (parts.length >= 2) {
        const timestamp = parseInt(parts[1]);
        return isNaN(timestamp) ? 0 : timestamp;
      }
      return 0;
    }
    
    // æ”¹å–„çš„æ¸²æŸ“å‡½æ•¸
    function render() {
      const allLists = getAllLists();
      container.innerHTML = "";
      
      if (allLists.length === 0) {
        container.innerHTML = '<li style="justify-content: center; background: #16213e;">ç›®å‰æ²’æœ‰ä»»ä½•æ¸…å–®ã€‚</li>';
        return;
      }
      
      allLists.forEach(list => {
        const li = document.createElement("li");
        
        // å‰µå»ºé€£çµå…ƒç´ 
        const link = document.createElement("a");
        link.href = `list.html?id=${encodeURIComponent(list.id)}`;
        link.textContent = list.title; // ä½¿ç”¨ textContent é˜²æ­¢ XSS
        
        // å‰µå»ºåˆªé™¤æŒ‰éˆ•
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "åˆªé™¤";
        deleteBtn.addEventListener("click", () => deleteList(list.id));
        
        li.appendChild(link);
        li.appendChild(deleteBtn);
        container.appendChild(li);
      });
    }

    // æ”¹å–„çš„æ–°å¢æ¸…å–®å‡½æ•¸
    function addList() {
      const id = generateId();
      const defaultTitle = "æ–°æ¸…å–®";
      
      // æª¢æŸ¥ ID æ˜¯å¦å·²å­˜åœ¨ï¼ˆé›–ç„¶æ©Ÿç‡å¾ˆä½ï¼‰
      const titleKey = id + "_title";
      const itemsKey = id + "_items";
      
      if (safeGetItem(titleKey) !== null || safeGetItem(itemsKey) !== null) {
        showError('ç”¢ç”Ÿå”¯ä¸€ ID å¤±æ•—ï¼Œè«‹é‡è©¦');
        return;
      }
      
      // é—œéµä¿®æ­£ï¼šç¢ºä¿è³‡æ–™å„²å­˜çš„ä¸€è‡´æ€§
      console.log('Creating new list with ID:', id);
      console.log('Title key:', titleKey);
      console.log('Items key:', itemsKey);
      
      // å„²å­˜è³‡æ–™
      const titleSaved = safeSetItem(titleKey, defaultTitle);
      const itemsSaved = safeSetItem(itemsKey, JSON.stringify(['']));
      
      if (titleSaved && itemsSaved) {
        console.log('Successfully saved:', {
          title: safeGetItem(titleKey),
          items: safeGetItem(itemsKey)
        });
        
        // å…ˆæ›´æ–°æ¯æ¸…å–®é¡¯ç¤ºï¼Œå†å°èˆª
        render();
        
        // å»¶é²å°èˆªï¼Œç¢ºä¿æ¸²æŸ“å®Œæˆ
        setTimeout(() => {
          window.location.href = `list.html?id=${encodeURIComponent(id)}`;
        }, 100);
      } else {
        showError('å»ºç«‹æ¸…å–®å¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    }
    
    // æ”¹å–„çš„åˆªé™¤æ¸…å–®å‡½æ•¸
    function deleteList(id) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹æ¸…å–®å—ï¼Ÿé€™å°‡åŒæ™‚ç§»é™¤æ¸…å–®æ¨™é¡Œå’Œå…§å®¹ã€‚")) {
        return;
      }
      
      // åˆªé™¤ç›¸é—œçš„æ‰€æœ‰ keys
      const titleRemoved = safeRemoveItem(id + "_title");
      const itemsRemoved = safeRemoveItem(id + "_items");
      
      if (titleRemoved && itemsRemoved) {
        render(); // é‡æ–°æ¸²æŸ“
      }
    }
    
    // äº‹ä»¶ç›£è½å™¨
    document.getElementById("addBtn").addEventListener("click", addList);
    
    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ localStorage æ˜¯å¦å¯ç”¨
    function checkLocalStorageAvailability() {
      try {
        const testKey = '__test_key__';
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        return true;
      } catch (e) {
        showError('ç€è¦½å™¨ä¸æ”¯æ´æœ¬åœ°å„²å­˜åŠŸèƒ½ï¼Œæ‡‰ç”¨å¯èƒ½ç„¡æ³•æ­£å¸¸é‹ä½œ');
        return false;
      }
    }
    
    // åˆå§‹åŒ–
    if (checkLocalStorageAvailability()) {
      render();
      
      // ç›£è½ localStorage è®ŠåŒ–ï¼ˆç•¶å¾å­æ¸…å–®è¿”å›æ™‚é‡æ–°æ¸²æŸ“ï¼‰
      window.addEventListener('storage', function(e) {
        if (e.key && e.key.includes('_title')) {
          console.log('Title updated for:', e.key, 'New value:', e.newValue);
          render();
        }
      });
      
      // ç›£è½é é¢ç„¦é»è®ŠåŒ–ï¼ˆç•¶å¾å­é é¢è¿”å›æ™‚é‡æ–°æ¸²æŸ“ï¼‰
      window.addEventListener('focus', function() {
        console.log('Page focused, re-rendering...');
        render();
      });
      
      // ç›£è½é é¢é¡¯ç¤ºäº‹ä»¶ï¼ˆç€è¦½å™¨å‰é€²å¾Œé€€ï¼‰
      window.addEventListener('pageshow', function() {
        console.log('Page shown, re-rendering...');
        render();
      });
    }
    
    // èª¿è©¦ï¼šé¡¯ç¤ºç•¶å‰æ‰€æœ‰ localStorage å…§å®¹
    function debugLocalStorage() {
      console.log('=== Current localStorage content ===');
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('list_')) {
          console.log(key, ':', localStorage.getItem(key));
        }
      }
      console.log('=====================================');
    }
    
    // åœ¨é–‹ç™¼æ™‚å¯ä»¥èª¿ç”¨æ­¤å‡½æ•¸æŸ¥çœ‹ localStorage ç‹€æ…‹
    window.debugLocalStorage = debugLocalStorage;
  </script>
</body>
</html>

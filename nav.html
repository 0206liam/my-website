<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¶²ç«™ç®¡ç†å°èˆª</title>
<style>
body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    background: #f2f3f5;
    color: #222;
}
h1 {
    text-align: center;
    margin: 44px 0 32px;
    font-weight: 650;
    font-size: 40px;
    letter-spacing: 1px;
}

/* é›²ç«¯æŒ‰éˆ•å€åŸŸ */
#backup-controls {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}
.cloud-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 14px 24px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(102,126,234,.4);
    transition: all .3s;
    display: flex;
    align-items: center;
    gap: 8px;
}
.cloud-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(102,126,234,.5);
}
.cloud-btn:active {
    transform: translateY(0);
}

/* å½ˆçª—æ¨£å¼ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}
.modal.show {
    display: flex;
}
.modal-content {
    background: white;
    border-radius: 16px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,.3);
}
.modal-title {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 20px;
    text-align: center;
}
.modal-input {
    width: 100%;
    padding: 14px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 16px;
    margin-bottom: 15px;
    box-sizing: border-box;
    font-family: monospace;
}
.modal-input:focus {
    outline: none;
    border-color: #007aff;
}
.modal-buttons {
    display: flex;
    gap: 10px;
}
.modal-btn {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s;
}
.modal-btn-primary {
    background: #007aff;
    color: white;
}
.modal-btn-primary:hover {
    background: #0051d5;
}
.modal-btn-secondary {
    background: #f0f0f0;
    color: #666;
}
.modal-btn-secondary:hover {
    background: #e0e0e0;
}
.modal-message {
    text-align: center;
    color: #666;
    margin-bottom: 15px;
    line-height: 1.5;
    font-size: 14px;
}
.modal-success {
    color: #34c759;
}
.modal-error {
    color: #ff3b30;
}
.modal-label {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    display: block;
}
.modal-help {
    font-size: 13px;
    color: #888;
    margin-bottom: 15px;
    line-height: 1.4;
}
.modal-help a {
    color: #007aff;
    text-decoration: none;
}
.modal-help a:hover {
    text-decoration: underline;
}
.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 15px;
}
.status-ready {
    background: #d1f4e0;
    color: #1a7f37;
}
.status-notset {
    background: #fff3cd;
    color: #856404;
}
.backup-info {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 12px 16px;
    margin-bottom: 15px;
    font-size: 13px;
    color: #666;
    line-height: 1.6;
}
.backup-info-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
}
.backup-info-item:last-child {
    margin-bottom: 0;
}
.backup-info-label {
    font-weight: 600;
    color: #333;
}
.action-section {
    margin-top: 25px;
    padding-top: 20px;
    border-top: 2px solid #f0f0f0;
}
.action-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
}
.action-btn {
    padding: 16px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    background: white;
    cursor: pointer;
    transition: all .2s;
    text-align: center;
}
.action-btn:hover {
    border-color: #007aff;
    background: #f8f9ff;
    transform: translateY(-2px);
}
.action-btn-icon {
    font-size: 28px;
    margin-bottom: 8px;
}
.action-btn-text {
    font-size: 15px;
    font-weight: 600;
    color: #333;
}
.action-btn-desc {
    font-size: 12px;
    color: #888;
    margin-top: 4px;
}
.settings-section {
    margin-top: 20px;
}
.settings-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
    margin-bottom: 15px;
}
.settings-toggle:hover {
    background: #e9ecef;
}
.settings-toggle-text {
    font-size: 14px;
    font-weight: 600;
    color: #333;
}
.settings-toggle-icon {
    color: #888;
    transition: transform .2s;
}
.settings-toggle-icon.open {
    transform: rotate(180deg);
}
.settings-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height .3s ease-out;
}
.settings-content.open {
    max-height: 500px;
}

#file-list {
    max-width: 1100px;
    margin: auto;
    padding: 0 24px 48px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 18px;
}
.item {
    background: #fff;
    border-radius: 14px;
    padding: 20px;
    text-decoration: none;
    color: #222;
    box-shadow: 0 4px 12px rgba(0,0,0,.08);
    transition: transform .15s, box-shadow .15s;
}
.item:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 22px rgba(0,0,0,.14);
}
.item-title {
    font-size: 20px;
    font-weight: 600;
}
.path {
    font-size: 15px;
    color: #777;
    margin-top: 8px;
}
footer {
    text-align: center;
    padding: 24px;
    font-size: 14px;
    color: #aaa;
}

@media (max-width: 600px) {
    .cloud-btn {
        padding: 12px 18px;
        font-size: 15px;
    }
    .action-buttons {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>

<div id="backup-controls">
    <button class="cloud-btn" onclick="showCloudModal()">
        <span>â˜ï¸</span>
        <span>é›²ç«¯</span>
    </button>
</div>

<div id="cloud-modal" class="modal">
    <div class="modal-content">
        <div class="modal-title">â˜ï¸ é›²ç«¯å‚™ä»½ç®¡ç†</div>
        
        <div class="modal-message">
            <span id="token-status" class="status-badge status-notset">âš ï¸ å°šæœªè¨­å®š</span>
        </div>
        
        <div class="backup-info" id="backup-time-info" style="display:none;">
            <div class="backup-info-item">
                <span class="backup-info-label">ğŸ“… æœ¬åœ°å‚™ä»½:</span>
                <span id="last-backup-time">å¾æœª</span>
            </div>
            <div class="backup-info-item">
                <span class="backup-info-label">â˜ï¸ é›²ç«¯å‚™ä»½:</span>
                <span id="cloud-backup-time">--</span>
            </div>
        </div>
        
        <div class="action-section">
            <div class="action-title">ğŸ“¦ å¿«é€Ÿæ“ä½œ</div>
            <div class="action-buttons">
                <div class="action-btn" onclick="doBackup()">
                    <div class="action-btn-icon">ğŸ“¤</div>
                    <div class="action-btn-text">å‚™ä»½</div>
                    <div class="action-btn-desc">ä¸Šå‚³åˆ°é›²ç«¯</div>
                </div>
                <div class="action-btn" onclick="confirmRestore()">
                    <div class="action-btn-icon">ğŸ“¥</div>
                    <div class="action-btn-text">é‚„åŸ</div>
                    <div class="action-btn-desc">å¾é›²ç«¯ä¸‹è¼‰</div>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-toggle" onclick="toggleSettings()">
                <span class="settings-toggle-text">âš™ï¸ é€²éšè¨­å®š</span>
                <span class="settings-toggle-icon" id="settings-toggle-icon">â–¼</span>
            </div>
            
            <div class="settings-content" id="settings-content">
                <label class="modal-label">GitHub Personal Access Token</label>
                <div class="modal-help">
                    éœ€è¦æœ‰ <strong>gist</strong> æ¬Šé™çš„ Tokenã€‚
                    <a href="https://github.com/settings/tokens/new" target="_blank">é»æ­¤ç”¢ç”Ÿ â†’</a>
                </div>
                <input type="password" class="modal-input" id="token-input" placeholder="ghp_xxxxxxxxxxxxxx">
                
                <label class="modal-label">Gist ID</label>
                <div class="modal-help">
                    å»ºç«‹ä¸€å€‹ secret gistï¼Œæª”åç‚º backup.jsonï¼Œå…§å®¹ç‚º {}
                </div>
                <input type="text" class="modal-input" id="gist-input" placeholder="d2822cb27c9b0f9ae576bb1adaebfff1" value="d2822cb27c9b0f9ae576bb1adaebfff1">
                
                <button class="modal-btn modal-btn-primary" onclick="saveSettings()" style="width:100%; margin-top:10px;">ğŸ’¾ å„²å­˜è¨­å®š</button>
            </div>
        </div>
        
        <div class="modal-buttons" style="margin-top:25px;">
            <button class="modal-btn modal-btn-secondary" onclick="closeModal('cloud-modal')" style="width:100%;">é—œé–‰</button>
        </div>
    </div>
</div>

<div id="result-modal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="result-title">çµæœ</div>
        <div class="modal-message" id="result-message"></div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-primary" onclick="closeModal('result-modal')" style="width:100%">ç¢ºå®š</button>
        </div>
    </div>
</div>

<div id="confirm-restore-modal" class="modal">
    <div class="modal-content">
        <div class="modal-title">âš ï¸ ç¢ºèªé‚„åŸ</div>
        <div class="modal-message" style="color:#ff3b30; font-weight:600;">
            é€™å°‡æœƒè¦†è“‹ç›®å‰çš„æœ¬åœ°è³‡æ–™ï¼<br>
            æ˜¯å¦ç¢ºå®šè¦å¾é›²ç«¯é‚„åŸï¼Ÿ
        </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="closeModal('confirm-restore-modal')">å–æ¶ˆ</button>
            <button class="modal-btn modal-btn-primary" onclick="doRestore()">ç¢ºèªé‚„åŸ</button>
        </div>
    </div>
</div>

<h1>ğŸŒ ç¶²ç«™ç¸½è¦½</h1>
<div id="file-list"></div>
<footer>
    Â© 2025 0206liam Â· GitHub Pages
</footer>

<script>
// GitHub è¨­å®š
const owner = "0206liam";
const repo = "my-website";
const container = document.getElementById("file-list");

// å‚™ä»½è¨­å®š
const TOKEN_KEY = "github_backup_token";
const GIST_KEY = "github_backup_gist";
const LAST_BACKUP_TIME_KEY = "last_backup_time";

/* å»ºç«‹ä¸€å€‹å¡ç‰‡ */
function createItem(title, href, pathText) {
    const a = document.createElement("a");
    a.href = window.location.origin + "/" + repo + "/" + href;
    a.className = "item";
    a.innerHTML = `
        <div class="item-title">${title}</div>
        <div class="path">${pathText}</div>
    `;
    container.appendChild(a);
}

/* è™•ç†è³‡æ–™å¤¾ */
async function handleFolder(folderPath, folderName) {
    const res = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contents/${folderPath}`
    );
    const items = await res.json();
    const indexFile = items.find(
        f => f.type === "file" && f.name === "index.html"
    );
    if (indexFile) {
        createItem(
            "ğŸ“ " + folderName,
            folderPath + "/",
            folderPath + "/"
        );
    } else {
        items.forEach(file => {
            if (
                file.type === "file" &&
                file.name.endsWith(".html")
            ) {
                createItem(
                    file.name.replace(".html", ""),
                    file.path,
                    file.path
                );
            }
        });
    }
}

/* è®€å–æ ¹ç›®éŒ„ */
async function loadRoot() {
    const res = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contents/`
    );
    const items = await res.json();
    for (const item of items) {
        if (item.type === "dir") {
            await handleFolder(item.path, item.name);
        }
        if (
            item.type === "file" &&
            item.name.endsWith(".html") &&
            item.name !== "index.html" &&
            item.name !== "nav.html"
        ) {
            createItem(
                item.name.replace(".html", ""),
                item.path,
                item.path
            );
        }
    }
}

// ========== å‚™ä»½/é‚„åŸåŠŸèƒ½ ==========

function getStoredToken() {
    return localStorage.getItem(TOKEN_KEY);
}

function getStoredGistId() {
    return localStorage.getItem(GIST_KEY) || "d2822cb27c9b0f9ae576bb1adaebfff1";
}

function getLastBackupTime() {
    return localStorage.getItem(LAST_BACKUP_TIME_KEY);
}

function setLastBackupTime(timestamp) {
    localStorage.setItem(LAST_BACKUP_TIME_KEY, timestamp);
}

function formatDateTime(timestamp) {
    if (!timestamp) return "å¾æœª";
    const date = new Date(timestamp);
    return date.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
}

function updateTokenStatus() {
    const token = getStoredToken();
    const statusEl = document.getElementById('token-status');
    const backupTimeInfo = document.getElementById('backup-time-info');
    const lastBackupTimeEl = document.getElementById('last-backup-time');
    
    if (token) {
        statusEl.className = 'status-badge status-ready';
        statusEl.textContent = 'âœ… å·²è¨­å®š';
        
        const lastBackupTime = getLastBackupTime();
        lastBackupTimeEl.textContent = formatDateTime(lastBackupTime);
        backupTimeInfo.style.display = 'block';
    } else {
        statusEl.className = 'status-badge status-notset';
        statusEl.textContent = 'âš ï¸ å°šæœªè¨­å®š';
        backupTimeInfo.style.display = 'none';
    }
}

function toggleSettings() {
    const content = document.getElementById('settings-content');
    const icon = document.getElementById('settings-toggle-icon');
    
    if (content.classList.contains('open')) {
        content.classList.remove('open');
        icon.classList.remove('open');
    } else {
        content.classList.add('open');
        icon.classList.add('open');
    }
}

async function showCloudModal() {
    const token = getStoredToken();
    const gistId = getStoredGistId();
    
    document.getElementById('token-input').value = token || '';
    document.getElementById('gist-input').value = gistId;
    updateTokenStatus();
    
    // å¦‚æœå·²è¨­å®š Tokenï¼Œè¼‰å…¥é›²ç«¯å‚™ä»½æ™‚é–“
    if (token) {
        const cloudTimeEl = document.getElementById('cloud-backup-time');
        cloudTimeEl.textContent = 'è¼‰å…¥ä¸­...';
        
        try {
            const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                headers: {
                    'Authorization': `token ${token}`
                }
            });
            
            if (response.ok) {
                const gist = await response.json();
                const content = gist.files['backup.json'].content;
                const data = JSON.parse(content);
                
                if (data._backup_timestamp) {
                    cloudTimeEl.textContent = formatDateTime(data._backup_timestamp);
                } else {
                    cloudTimeEl.textContent = 'æœªçŸ¥';
                }
            } else {
                cloudTimeEl.textContent = 'ç„¡æ³•å–å¾—';
            }
        } catch (error) {
            cloudTimeEl.textContent = 'è®€å–å¤±æ•—';
        }
    }
    
    document.getElementById('cloud-modal').classList.add('show');
}

function saveSettings() {
    const token = document.getElementById('token-input').value.trim();
    const gistId = document.getElementById('gist-input').value.trim();
    
    if (!token) {
        showResult('âŒ è¨­å®šå¤±æ•—', 'è«‹è¼¸å…¥ GitHub Token', false);
        return;
    }
    
    if (!gistId) {
        showResult('âŒ è¨­å®šå¤±æ•—', 'è«‹è¼¸å…¥ Gist ID', false);
        return;
    }
    
    localStorage.setItem(TOKEN_KEY, token);
    localStorage.setItem(GIST_KEY, gistId);
    
    updateTokenStatus();
    showResult('âœ… è¨­å®šæˆåŠŸ', 'Token å’Œ Gist ID å·²å„²å­˜!', true);
    
    // é‡æ–°è¼‰å…¥é›²ç«¯å‚™ä»½æ™‚é–“
    setTimeout(() => {
        closeModal('result-modal');
        showCloudModal();
    }, 1500);
}

function confirmRestore() {
    if (!getStoredToken()) {
        showResult('âš ï¸ å°šæœªè¨­å®š', 'è«‹å…ˆåœ¨é€²éšè¨­å®šä¸­é…ç½® GitHub Token', false);
        return;
    }
    
    closeModal('cloud-modal');
    document.getElementById('confirm-restore-modal').classList.add('show');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('show');
}

function showResult(title, message, isSuccess) {
    document.getElementById('result-title').textContent = title;
    const msgEl = document.getElementById('result-message');
    msgEl.textContent = message;
    msgEl.className = 'modal-message ' + (isSuccess ? 'modal-success' : 'modal-error');
    document.getElementById('result-modal').classList.add('show');
}

async function doBackup() {
    if (!getStoredToken()) {
        showResult('âš ï¸ å°šæœªè¨­å®š', 'è«‹å…ˆåœ¨é€²éšè¨­å®šä¸­é…ç½® GitHub Token', false);
        return;
    }
    
    const token = getStoredToken();
    const gistId = getStoredGistId();
    
    try {
        const data = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key !== TOKEN_KEY && key !== GIST_KEY) {
                data[key] = localStorage.getItem(key);
            }
        }
        
        // åŠ å…¥å‚™ä»½æ™‚é–“æˆ³è¨˜
        const timestamp = new Date().toISOString();
        data._backup_timestamp = timestamp;
        
        const response = await fetch(`https://api.github.com/gists/${gistId}`, {
            method: 'PATCH',
            headers: {
                'Authorization': `token ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                files: {
                    'backup.json': {
                        content: JSON.stringify(data, null, 2)
                    }
                }
            })
        });
        
        if (response.ok) {
            setLastBackupTime(timestamp);
            showResult('âœ… å‚™ä»½æˆåŠŸ', `è³‡æ–™å·²ä¸Šå‚³åˆ°é›²ç«¯!\nå‚™ä»½æ™‚é–“: ${formatDateTime(timestamp)}`, true);
            // æ›´æ–°é›²ç«¯æ™‚é–“é¡¯ç¤º
            if (document.getElementById('cloud-modal').classList.contains('show')) {
                setTimeout(() => {
                    closeModal('result-modal');
                    showCloudModal();
                }, 1500);
            }
        } else {
            const error = await response.json();
            showResult('âŒ å‚™ä»½å¤±æ•—', error.message || 'ä¸Šå‚³æ™‚ç™¼ç”ŸéŒ¯èª¤', false);
        }
    } catch (error) {
        showResult('âŒ å‚™ä»½å¤±æ•—', 'ç¶²è·¯éŒ¯èª¤: ' + error.message, false);
    }
}

async function doRestore() {
    const token = getStoredToken();
    const gistId = getStoredGistId();
    
    // é—œé–‰ç¢ºèªè¦–çª—
    closeModal('confirm-restore-modal');
    
    try {
        const response = await fetch(`https://api.github.com/gists/${gistId}`, {
            headers: {
                'Authorization': `token ${token}`
            }
        });
        
        if (!response.ok) {
            const error = await response.json();
            showResult('âŒ é‚„åŸå¤±æ•—', error.message || 'ä¸‹è¼‰æ™‚ç™¼ç”ŸéŒ¯èª¤', false);
            return;
        }
        
        const gist = await response.json();
        const content = gist.files['backup.json'].content;
        const data = JSON.parse(content);
        
        const currentToken = getStoredToken();
        const currentGistId = getStoredGistId();
        const backupTimestamp = data._backup_timestamp;
        
        localStorage.clear();
        localStorage.setItem(TOKEN_KEY, currentToken);
        localStorage.setItem(GIST_KEY, currentGistId);
        
        for (const key in data) {
            if (key !== '_backup_timestamp') {
                localStorage.setItem(key, data[key]);
            }
        }
        
        if (backupTimestamp) {
            setLastBackupTime(backupTimestamp);
        }
        
        showResult('âœ… é‚„åŸæˆåŠŸ', `è³‡æ–™å·²å¾é›²ç«¯ä¸‹è¼‰!\nå‚™ä»½æ™‚é–“: ${formatDateTime(backupTimestamp)}\n\né é¢å°‡åœ¨ 2 ç§’å¾Œé‡æ–°æ•´ç†`, true);
        
        setTimeout(() => {
            location.reload();
        }, 2000);
        
    } catch (error) {
        showResult('âŒ é‚„åŸå¤±æ•—', 'ç¶²è·¯éŒ¯èª¤: ' + error.message, false);
    }
}

// è¼‰å…¥ç¶²ç«™åˆ—è¡¨
loadRoot();
</script>
</body>
</html>

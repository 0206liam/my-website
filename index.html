<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¶²ç«™ç¸½è¦½</title>
<style>
body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    background: #f2f3f5;
    color: #222;
}
h1 {
    text-align: center;
    margin: 44px 0 32px;
    font-weight: 650;
    font-size: 40px;
    letter-spacing: 1px;
}

/* å‚™ä»½æŒ‰éˆ•å€åŸŸ */
#backup-controls {
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    gap: 10px;
    z-index: 1000;
}
.backup-btn {
    background: #007aff;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,122,255,.3);
    transition: all .2s;
}
.backup-btn:hover {
    background: #0051d5;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,122,255,.4);
}
.backup-btn.settings {
    background: #8e8e93;
}
.backup-btn.settings:hover {
    background: #636366;
}
.backup-btn:active {
    transform: translateY(0);
}

/* å½ˆçª—æ¨£å¼ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}
.modal.show {
    display: flex;
}
.modal-content {
    background: white;
    border-radius: 16px;
    padding: 30px;
    max-width: 450px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,.3);
}
.modal-title {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 20px;
    text-align: center;
}
.modal-input {
    width: 100%;
    padding: 14px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 16px;
    margin-bottom: 15px;
    box-sizing: border-box;
    font-family: monospace;
}
.modal-input:focus {
    outline: none;
    border-color: #007aff;
}
.modal-buttons {
    display: flex;
    gap: 10px;
}
.modal-btn {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s;
}
.modal-btn-primary {
    background: #007aff;
    color: white;
}
.modal-btn-primary:hover {
    background: #0051d5;
}
.modal-btn-secondary {
    background: #f0f0f0;
    color: #666;
}
.modal-btn-secondary:hover {
    background: #e0e0e0;
}
.modal-message {
    text-align: center;
    color: #666;
    margin-bottom: 15px;
    line-height: 1.5;
    font-size: 14px;
}
.modal-success {
    color: #34c759;
}
.modal-error {
    color: #ff3b30;
}
.modal-label {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    display: block;
}
.modal-help {
    font-size: 13px;
    color: #888;
    margin-bottom: 15px;
    line-height: 1.4;
}
.modal-help a {
    color: #007aff;
    text-decoration: none;
}
.modal-help a:hover {
    text-decoration: underline;
}
.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 15px;
}
.status-ready {
    background: #d1f4e0;
    color: #1a7f37;
}
.status-notset {
    background: #fff3cd;
    color: #856404;
}

#file-list {
    max-width: 1100px;
    margin: auto;
    padding: 0 24px 48px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 18px;
}
.item {
    background: #fff;
    border-radius: 14px;
    padding: 20px;
    text-decoration: none;
    color: #222;
    box-shadow: 0 4px 12px rgba(0,0,0,.08);
    transition: transform .15s, box-shadow .15s;
}
.item:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 22px rgba(0,0,0,.14);
}
.item-title {
    font-size: 20px;
    font-weight: 600;
}
.path {
    font-size: 15px;
    color: #777;
    margin-top: 8px;
}
footer {
    text-align: center;
    padding: 24px;
    font-size: 14px;
    color: #aaa;
}

@media (max-width: 600px) {
    #backup-controls {
        top: 10px;
        right: 10px;
        flex-direction: column;
    }
    .backup-btn {
        padding: 10px 16px;
        font-size: 14px;
    }
}
</style>
</head>
<body>

<!-- å‚™ä»½æŒ‰éˆ• -->
<div id="backup-controls">
    <button class="backup-btn settings" onclick="showSettingsModal()">âš™ï¸ è¨­å®š</button>
    <button class="backup-btn" onclick="showBackupModal()">ğŸ“¤ å‚™ä»½</button>
    <button class="backup-btn" onclick="showRestoreModal()">ğŸ“¥ é‚„åŸ</button>
</div>

<!-- è¨­å®šå½ˆçª— -->
<div id="settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-title">âš™ï¸ å‚™ä»½è¨­å®š</div>
        <div class="modal-message">
            <span id="token-status" class="status-badge status-notset">âš ï¸ å°šæœªè¨­å®š</span>
        </div>
        
        <label class="modal-label">GitHub Personal Access Token</label>
        <div class="modal-help">
            éœ€è¦æœ‰ <strong>gist</strong> æ¬Šé™çš„ Tokenã€‚
            <a href="https://github.com/settings/tokens/new" target="_blank">é»æ­¤ç”¢ç”Ÿ â†’</a>
        </div>
        <input type="password" class="modal-input" id="token-input" placeholder="ghp_xxxxxxxxxxxxxx">
        
        <label class="modal-label">Gist ID</label>
        <div class="modal-help">
            å»ºç«‹ä¸€å€‹ secret gistï¼Œæª”åç‚º backup.jsonï¼Œå…§å®¹ç‚º {}
        </div>
        <input type="text" class="modal-input" id="gist-input" placeholder="d2822cb27c9b0f9ae576bb1adaebfff1" value="d2822cb27c9b0f9ae576bb1adaebfff1">
        
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="closeModal('settings-modal')">å–æ¶ˆ</button>
            <button class="modal-btn modal-btn-primary" onclick="saveSettings()">å„²å­˜</button>
        </div>
    </div>
</div>

<!-- å‚™ä»½å½ˆçª— -->
<div id="backup-modal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ğŸ“¤ å‚™ä»½åˆ°é›²ç«¯</div>
        <div class="modal-message">è«‹è¼¸å…¥å‚™ä»½ç¢¼ä»¥ä¸Šå‚³è³‡æ–™</div>
        <input type="password" class="modal-input" id="backup-password" placeholder="è«‹è¼¸å…¥å‚™ä»½ç¢¼">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="closeModal('backup-modal')">å–æ¶ˆ</button>
            <button class="modal-btn modal-btn-primary" onclick="doBackup()">ä¸Šå‚³</button>
        </div>
    </div>
</div>

<!-- é‚„åŸå½ˆçª— -->
<div id="restore-modal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ğŸ“¥ å¾é›²ç«¯é‚„åŸ</div>
        <div class="modal-message">âš ï¸ é€™æœƒè¦†è“‹ç›®å‰çš„æœ¬åœ°è³‡æ–™<br>è«‹è¼¸å…¥å‚™ä»½ç¢¼ä»¥ä¸‹è¼‰è³‡æ–™</div>
        <input type="password" class="modal-input" id="restore-password" placeholder="è«‹è¼¸å…¥å‚™ä»½ç¢¼">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="closeModal('restore-modal')">å–æ¶ˆ</button>
            <button class="modal-btn modal-btn-primary" onclick="doRestore()">ä¸‹è¼‰</button>
        </div>
    </div>
</div>

<!-- çµæœå½ˆçª— -->
<div id="result-modal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="result-title">çµæœ</div>
        <div class="modal-message" id="result-message"></div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-primary" onclick="closeModal('result-modal')" style="width:100%">ç¢ºå®š</button>
        </div>
    </div>
</div>

<h1>ğŸŒ ç¶²ç«™ç¸½è¦½</h1>
<div id="file-list"></div>
<footer>
    Â© 2025 0206liam Â· GitHub Pages
</footer>

<script>
// GitHub è¨­å®š
const owner = "0206liam";
const repo = "my-website";
const container = document.getElementById("file-list");

// å‚™ä»½è¨­å®š
const BACKUP_PASSWORD = "0206";
const TOKEN_KEY = "github_backup_token";
const GIST_KEY = "github_backup_gist";

/* å»ºç«‹ä¸€å€‹å¡ç‰‡ */
function createItem(title, href, pathText) {
    const a = document.createElement("a");
    a.href = href;
    a.className = "item";
    a.innerHTML = `
        <div class="item-title">${title}</div>
        <div class="path">${pathText}</div>
    `;
    container.appendChild(a);
}

/* è™•ç†è³‡æ–™å¤¾ */
async function handleFolder(folderPath, folderName) {
    const res = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contents/${folderPath}`
    );
    const items = await res.json();
    const indexFile = items.find(
        f => f.type === "file" && f.name === "index.html"
    );
    if (indexFile) {
        createItem(
            "ğŸ“ " + folderName,
            folderPath + "/",
            folderPath + "/"
        );
    } else {
        items.forEach(file => {
            if (
                file.type === "file" &&
                file.name.endsWith(".html")
            ) {
                createItem(
                    file.name.replace(".html", ""),
                    file.path,
                    file.path
                );
            }
        });
    }
}

/* è®€å–æ ¹ç›®éŒ„ */
async function loadRoot() {
    const res = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contents/`
    );
    const items = await res.json();
    for (const item of items) {
        if (item.type === "dir") {
            await handleFolder(item.path, item.name);
        }
        if (
            item.type === "file" &&
            item.name.endsWith(".html") &&
            item.name !== "index.html"
        ) {
            createItem(
                item.name.replace(".html", ""),
                item.path,
                item.path
            );
        }
    }
}

// ========== å‚™ä»½/é‚„åŸåŠŸèƒ½ ==========

function getStoredToken() {
    return localStorage.getItem(TOKEN_KEY);
}

function getStoredGistId() {
    return localStorage.getItem(GIST_KEY) || "d2822cb27c9b0f9ae576bb1adaebfff1";
}

function updateTokenStatus() {
    const token = getStoredToken();
    const statusEl = document.getElementById('token-status');
    if (token) {
        statusEl.className = 'status-badge status-ready';
        statusEl.textContent = 'âœ… å·²è¨­å®š';
    } else {
        statusEl.className = 'status-badge status-notset';
        statusEl.textContent = 'âš ï¸ å°šæœªè¨­å®š';
    }
}

function showSettingsModal() {
    const token = getStoredToken();
    const gistId = getStoredGistId();
    
    document.getElementById('token-input').value = token || '';
    document.getElementById('gist-input').value = gistId;
    updateTokenStatus();
    document.getElementById('settings-modal').classList.add('show');
}

function saveSettings() {
    const token = document.getElementById('token-input').value.trim();
    const gistId = document.getElementById('gist-input').value.trim();
    
    if (!token) {
        showResult('âŒ è¨­å®šå¤±æ•—', 'è«‹è¼¸å…¥ GitHub Token', false);
        return;
    }
    
    if (!gistId) {
        showResult('âŒ è¨­å®šå¤±æ•—', 'è«‹è¼¸å…¥ Gist ID', false);
        return;
    }
    
    localStorage.setItem(TOKEN_KEY, token);
    localStorage.setItem(GIST_KEY, gistId);
    
    closeModal('settings-modal');
    showResult('âœ… è¨­å®šæˆåŠŸ', 'Token å’Œ Gist ID å·²å„²å­˜ï¼', true);
}

function showBackupModal() {
    if (!getStoredToken()) {
        showResult('âš ï¸ å°šæœªè¨­å®š', 'è«‹å…ˆé»æ“Šã€Œâš™ï¸ è¨­å®šã€é…ç½® GitHub Token', false);
        return;
    }
    document.getElementById('backup-modal').classList.add('show');
    document.getElementById('backup-password').value = '';
    document.getElementById('backup-password').focus();
}

function showRestoreModal() {
    if (!getStoredToken()) {
        showResult('âš ï¸ å°šæœªè¨­å®š', 'è«‹å…ˆé»æ“Šã€Œâš™ï¸ è¨­å®šã€é…ç½® GitHub Token', false);
        return;
    }
    document.getElementById('restore-modal').classList.add('show');
    document.getElementById('restore-password').value = '';
    document.getElementById('restore-password').focus();
}

function closeModal(id) {
    document.getElementById(id).classList.remove('show');
}

function showResult(title, message, isSuccess) {
    document.getElementById('result-title').textContent = title;
    const msgEl = document.getElementById('result-message');
    msgEl.textContent = message;
    msgEl.className = 'modal-message ' + (isSuccess ? 'modal-success' : 'modal-error');
    document.getElementById('result-modal').classList.add('show');
}

async function doBackup() {
    const password = document.getElementById('backup-password').value;
    
    if (password !== BACKUP_PASSWORD) {
        showResult('âŒ å‚™ä»½å¤±æ•—', 'å‚™ä»½ç¢¼éŒ¯èª¤', false);
        closeModal('backup-modal');
        return;
    }
    
    const token = getStoredToken();
    const gistId = getStoredGistId();
    
    try {
        // æ”¶é›†æ‰€æœ‰ localStorage è³‡æ–™ï¼ˆæ’é™¤ token å’Œ gist idï¼‰
        const data = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key !== TOKEN_KEY && key !== GIST_KEY) {
                data[key] = localStorage.getItem(key);
            }
        }
        
        // ä¸Šå‚³åˆ° Gist
        const response = await fetch(`https://api.github.com/gists/${gistId}`, {
            method: 'PATCH',
            headers: {
                'Authorization': `token ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                files: {
                    'backup.json': {
                        content: JSON.stringify(data, null, 2)
                    }
                }
            })
        });
        
        if (response.ok) {
            showResult('âœ… å‚™ä»½æˆåŠŸ', 'è³‡æ–™å·²ä¸Šå‚³åˆ°é›²ç«¯ï¼', true);
        } else {
            const error = await response.json();
            showResult('âŒ å‚™ä»½å¤±æ•—', error.message || 'ä¸Šå‚³æ™‚ç™¼ç”ŸéŒ¯èª¤', false);
        }
    } catch (error) {
        showResult('âŒ å‚™ä»½å¤±æ•—', 'ç¶²è·¯éŒ¯èª¤ï¼š' + error.message, false);
    }
    
    closeModal('backup-modal');
}

async function doRestore() {
    const password = document.getElementById('restore-password').value;
    
    if (password !== BACKUP_PASSWORD) {
        showResult('âŒ é‚„åŸå¤±æ•—', 'å‚™ä»½ç¢¼éŒ¯èª¤', false);
        closeModal('restore-modal');
        return;
    }
    
    const token = getStoredToken();
    const gistId = getStoredGistId();
    
    try {
        // å¾ Gist ä¸‹è¼‰è³‡æ–™
        const response = await fetch(`https://api.github.com/gists/${gistId}`, {
            headers: {
                'Authorization': `token ${token}`
            }
        });
        
        if (!response.ok) {
            const error = await response.json();
            showResult('âŒ é‚„åŸå¤±æ•—', error.message || 'ä¸‹è¼‰æ™‚ç™¼ç”ŸéŒ¯èª¤', false);
            closeModal('restore-modal');
            return;
        }
        
        const gist = await response.json();
        const content = gist.files['backup.json'].content;
        const data = JSON.parse(content);
        
        // ä¿å­˜ç•¶å‰çš„ token å’Œ gist id
        const currentToken = getStoredToken();
        const currentGistId = getStoredGistId();
        
        // æ¸…ç©ºç¾æœ‰ localStorage
        localStorage.clear();
        
        // å…ˆæ¢å¾© token å’Œ gist id
        localStorage.setItem(TOKEN_KEY, currentToken);
        localStorage.setItem(GIST_KEY, currentGistId);
        
        // è¼‰å…¥é›²ç«¯è³‡æ–™
        for (const key in data) {
            localStorage.setItem(key, data[key]);
        }
        
        showResult('âœ… é‚„åŸæˆåŠŸ', 'è³‡æ–™å·²å¾é›²ç«¯ä¸‹è¼‰ï¼\né é¢å°‡åœ¨ 2 ç§’å¾Œé‡æ–°æ•´ç†', true);
        
        setTimeout(() => {
            location.reload();
        }, 2000);
        
    } catch (error) {
        showResult('âŒ é‚„åŸå¤±æ•—', 'ç¶²è·¯éŒ¯èª¤ï¼š' + error.message, false);
    }
    
    closeModal('restore-modal');
}

// Enter éµå¿«æ·éµ
document.getElementById('backup-password').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') doBackup();
});
document.getElementById('restore-password').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') doRestore();
});

// è¼‰å…¥ç¶²ç«™åˆ—è¡¨
loadRoot();
</script>
</body>
</html>
